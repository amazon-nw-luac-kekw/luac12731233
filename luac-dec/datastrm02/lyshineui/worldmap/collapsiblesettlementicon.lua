local StaticStationData = {
  Adjudicator = {
    name = "@NPC_Name_Adjudicator",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_npc_adjudicator.dds",
    description = "@NPC_Name_Adjudicator_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_faction3.dds"
  },
  Alchemist = {
    name = "@NPC_Name_Alchemist",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_npc_alchemist.dds",
    description = "@NPC_Name_Alchemist_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_faction1.dds"
  },
  Alchemy = {
    name = "@ui_alchemy",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_station_alchemy.dds",
    description = "@ui_alchemy_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_alchemy.dds"
  },
  Blacksmith = {
    name = "@ui_blacksmith",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_station_blacksmith.dds",
    description = "@ui_blacksmith_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_blacksmith.dds"
  },
  Commander = {
    name = "@NPC_Name_Captain",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_npc_captain.dds",
    description = "@NPC_Name_Captain_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_faction2.dds"
  },
  Carpentry = {
    name = "@ui_carpentry",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_station_carpentry.dds",
    description = "@ui_carpentry_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_carpentry.dds"
  },
  Claim = {
    name = "@ui_claimmarker",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_fortress_default.dds",
    description = "@ui_claimmarker_claimterritory",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_territoryplanningboard.dds"
  },
  Cooking = {
    name = "@cooking",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_station_cooking.dds",
    description = "@cooking_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_cooking.dds"
  },
  Engineering = {
    name = "@engineering_station",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_station_engineering.dds",
    description = "@ui_engineering_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_engineering.dds"
  },
  GlobalStorage = {
    name = "@ui_global_storage",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_storage.dds",
    description = "@ui_global_storage_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_storage.dds"
  },
  GovernorsDesk = {
    name = "@ui_governorsdesk",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_governorsdesk.dds",
    description = "@ui_governorsdesk_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_governorsDesk.dds"
  },
  Masonry = {
    name = "@ui_masonry",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_station_masonry.dds",
    description = "@ui_masonry_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_masonry.dds"
  },
  Outfitting = {
    name = "@outfitting",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_station_outfitting.dds",
    description = "@outfitting_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_outfitting.dds"
  },
  TerritoryPlanningBoard = {
    name = "@ui_territory_planning_board",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_planningboard.dds",
    description = "@ui_territory_planning_board_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_territoryPlanningBoard.dds"
  },
  Smelting = {
    name = "@ui_smelter",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_station_smelting.dds",
    description = "@ui_smelter_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_smelter.dds"
  },
  Tanning = {
    name = "@tanning",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_station_tanning.dds",
    description = "@tanning_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_tannery.dds"
  },
  TownProjectBoard = {
    name = "@ui_territory_board_town_project",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_townProjectBoard.dds",
    description = "@ui_territory_board_town_project_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_townProjectBoard.dds"
  },
  TradingPost = {
    name = "@ui_tradingpost",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_tradingpost.dds",
    description = "@ui_tradingpost_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_tradingpost.dds"
  },
  WarBoard = {
    name = "@ui_territory_board_war",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_warboard.dds",
    description = "@ui_territory_board_war_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_warBoard.dds"
  },
  WarCamp = {
    name = "@ui_territory_war_camp",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_warboard.dds",
    description = "@ui_territory_war_camp",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_warboard.dds"
  },
  Weaving = {
    name = "@weaving",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_station_weaving.dds",
    description = "@weaving_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_weaving.dds"
  },
  YourHomeEnabled = {
    name = "@ui_your_house_enabled",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_house_default.dds",
    description = "@ui_your_house_enabled",
    icon = "LyShineUI/Images/map/icon/icon_map_house.dds"
  },
  YourHomeDisabled = {
    name = "@ui_your_house_disabled",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_house_default.dds",
    description = "@ui_your_house_disabled",
    icon = "LyShineUI/Images/map/icon/icon_map_house_disabled.dds"
  },
  InnInteract = {
    name = "@ui_inn",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_inn_default.dds",
    description = "@ui_inn_map_tooltip",
    icon = "LyShineUI/Images/map/icon/icon_inn_inactive.dds"
  },
  YourInnInteract = {
    name = "@ui_your_inn",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_inn_default.dds",
    description = "@ui_your_inn",
    icon = "LyShineUI/Images/map/icon/icon_inn.dds"
  },
  Prospector = {
    name = "@ui_outpost_rush_title",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_territory_default.dds",
    description = "@NPC_Name_Prospector_desc",
    icon = "LyShineUI/Images/Icons/outpostrush/icon_outpostrush_map.dds"
  },
  OR_Armory = {
    name = "@ui_or_armory",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_outpostRush_armory.dds",
    description = "@ui_or_armory_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_armory0.dds"
  },
  OR_CommandPost = {
    name = "@ui_or_command_post",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_outpostRush_command.dds",
    description = "@ui_or_command_post_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_commandpost0.dds"
  },
  OR_Defense = {
    name = "@ui_or_defense",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_outpostRush_barrel.dds",
    description = "@ui_or_defense_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_turret.dds"
  },
  OR_Gate = {
    name = "@ui_or_gate",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_outpostRush_gate.dds",
    description = "@ui_or_gate_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_gate0.dds"
  },
  OR_ProtectionWard = {
    name = "@ui_or_protection_ward",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_outpostRush_protectionWard.dds",
    description = "@ui_or_protection_ward_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_governorsdesk.dds"
  },
  OR_Storage = {
    name = "@ui_or_storage",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_storage.dds",
    description = "@ui_or_storage_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_storage.dds"
  },
  OR_SummoningCircle = {
    name = "@ui_outpost_rush_summoning_circle",
    image = "LyShineUI/Images/map/tooltipimages/mapTooltip_outpost_default.dds",
    description = "@ui_outpost_rush_summoning_circle_desc",
    icon = "LyShineUI/Images/Icons/worldmap/worldmap_alchemy.dds"
  }
}
local CollapsibleSettlementIcon = {
  Properties = {
    SimpleCapitalIcon = {
      default = EntityId()
    },
    MainIconLayer = {
      default = EntityId()
    },
    StationsLayer = {
      default = EntityId()
    },
    DebugLabel = {
      default = EntityId()
    }
  },
  SETTLEMENT_MAP_WIDTH = 100,
  SETTLEMENT_HALF_WIDTH = 50,
  MAX_DISTANCE_STATION_ICON_SQ = 48400,
  houseIconButtonFlyoutContext = "houseIconButton"
}
local BaseElement = RequireScript("LyShineUI._Common.BaseElement")
BaseElement:CreateNewElement(CollapsibleSettlementIcon)
local fastTravelCommon = RequireScript("LyShineUI._Common.FastTravelCommon")
local timeHelpers = RequireScript("LyShineUI._Common.TimeHelperFunctions")
local FactionCommon = RequireScript("LyShineUI._Common.FactionCommon")
function CollapsibleSettlementIcon:OnInit()
  BaseElement.OnInit(self)
  self.oneScale = Vector2(1, 1)
  self.zeroScale = Vector2(0, 0)
  self.maxLevelWithVisibleIcons = 2
  self.zoomScales = {
    Vector2(1, 1),
    Vector2(0.5, 0.5),
    Vector2(0.25, 0.25),
    Vector2(0.25, 0.25)
  }
  self.mainZoomScales = {
    Vector2(4, 4),
    Vector2(2, 2),
    Vector2(1, 1),
    Vector2(0.5, 0.5),
    Vector2(0.5, 0.5),
    Vector2(0.5, 0.5),
    Vector2(0.5, 0.5)
  }
  self.stationIcons = {}
  local idx = 1
  repeat
    local iconEntity = UiElementBus.Event.FindChildByName(self.Properties.StationsLayer, string.format("StationIcon%d", idx))
    UiInteractableBus.Event.SetHoverEnterEventHandlingScale(iconEntity, Vector2(0.8, 0.8))
    local stationIcon = self.registrar:GetEntityTable(iconEntity)
    if stationIcon then
      table.insert(self.stationIcons, stationIcon)
    end
    idx = idx + 1
  until not stationIcon
end
function CollapsibleSettlementIcon:FillLandmarks()
  local immediateMatches = {
    [eTerritoryLandmarkType_Claim] = StaticStationData.Claim,
    [eTerritoryLandmarkType_GovernorsDesk] = StaticStationData.GovernorsDesk,
    [eTerritoryLandmarkType_TerritoryPlanningBoard] = StaticStationData.TerritoryPlanningBoard,
    [eTerritoryLandmarkType_WarBoard] = StaticStationData.WarBoard,
    [eTerritoryLandmarkType_WarCamp] = StaticStationData.WarCamp,
    [eTerritoryLandmarkType_CommunityGoalProvider] = StaticStationData.TownProjectBoard,
    [eTerritoryLandmarkType_TradingPost] = StaticStationData.TradingPost,
    [eTerritoryLandmarkType_InnInteract] = StaticStationData.InnInteract,
    [eTerritoryLandmarkType_GlobalStorage] = StaticStationData.GlobalStorage
  }
  local allLandmarks = {}
  local landmarksVector = MapComponentBus.Broadcast.GetLandmarksInTerritory(self.territoryId)
  if landmarksVector then
    local uniqueKeys = {}
    for i = 1, #landmarksVector do
      local landmarkData = landmarksVector[i]
      local key = string.format("%d-%s-%d-%d", landmarkData.landmarkType, landmarkData.landmarkData, landmarkData.worldPosition.x, landmarkData.worldPosition.y)
      if not uniqueKeys[key] then
        uniqueKeys[key] = true
        local landmark = {
          worldPosition = landmarkData.worldPosition:Clone()
        }
        landmark.staticData = immediateMatches[landmarkData.landmarkType]
        if landmarkData.landmarkType == eTerritoryLandmarkType_Settlement and self:IsSettlement() then
          self.worldPosition = Vector2(landmarkData.worldPosition.x, landmarkData.worldPosition.y)
        elseif landmarkData.landmarkType == eTerritoryLandmarkType_CraftingStation then
          local prefix = string.sub(landmarkData.landmarkData, 1, string.len(landmarkData.landmarkData) - 1)
          landmark.staticData = StaticStationData[prefix]
        elseif landmarkData.landmarkType == eTerritoryLandmarkType_FactionMissionProvider then
          local suffix = string.sub(landmarkData.landmarkData, 6)
          landmark.staticData = StaticStationData[suffix]
        elseif landmarkData.landmarkType == eTerritoryLandmarkType_OutpostRushSignUp then
          landmark.staticData = StaticStationData.Prospector
        end
        if landmark.staticData then
          table.insert(allLandmarks, landmark)
        end
      end
    end
  end
  local landmarks = {}
  for i, landmark in ipairs(allLandmarks) do
    local distSq = (landmark.worldPosition.x - self.worldPosition.x) * (landmark.worldPosition.x - self.worldPosition.x) + (landmark.worldPosition.y - self.worldPosition.y) * (landmark.worldPosition.y - self.worldPosition.y)
    if distSq <= self.MAX_DISTANCE_STATION_ICON_SQ then
      table.insert(landmarks, landmark)
    end
  end
  self.landmarks = landmarks
end
function CollapsibleSettlementIcon:UpdateHouse(taxesPaid)
  if not self.worldPosition or not self:IsSettlement() then
    return
  end
  if taxesPaid == nil then
    local ownedHouses = PlayerHousingClientRequestBus.Broadcast.GetOwnedHouseData()
    local homePos
    local hasUnpaidTaxes = false
    local plotEntityId
    for i = 1, #ownedHouses do
      local houseData = ownedHouses[i]
      local territoryId = MapComponentBus.Broadcast.GetContainingTerritory(houseData.housingPlotPos)
      if territoryId == self.territoryId then
        plotEntityId = PlayerHousingClientRequestBus.Broadcast.GetPlotEntityIdFromOwnedHouseData(houseData)
        homePos = houseData.housingPlotPos
        hasUnpaidTaxes = houseData.taxesDue <= timeHelpers:ServerNow()
        break
      end
    end
    if self.homeIcon then
      if homePos then
        local staticHomeIconData = hasUnpaidTaxes and StaticStationData.YourHomeDisabled or StaticStationData.YourHomeEnabled
        self.homeIcon:SetStationIconInfo(staticHomeIconData.name, staticHomeIconData.description, staticHomeIconData.image, self, self.OnStationRightClick, self.OnFocusHome, self.OnUnfocusHome)
        UiImageBus.Event.SetSpritePathname(self.homeIcon.Properties.Icon, staticHomeIconData.icon)
        self:SetStationIconPosition(self.homeIcon.entityId, homePos)
        UiElementBus.Event.SetIsEnabled(self.homeIcon.entityId, true)
      else
        UiElementBus.Event.SetIsEnabled(self.homeIcon.entityId, false)
      end
    end
    return plotEntityId
  elseif self.homeIcon then
    local staticHomeIconData = taxesPaid and StaticStationData.YourHomeEnabled or StaticStationData.YourHomeDisabled
    self.homeIcon:SetStationIconInfo(staticHomeIconData.name, staticHomeIconData.description, staticHomeIconData.image, self, self.OnStationRightClick, self.OnFocusHome, self.OnUnfocusHome)
    UiImageBus.Event.SetSpritePathname(self.homeIcon.Properties.Icon, staticHomeIconData.icon)
  end
end
function CollapsibleSettlementIcon:OnTaxesPaid()
  self:UpdateHouse(true)
end
function CollapsibleSettlementIcon:OnTaxesDue()
  self:UpdateHouse(false)
end
function CollapsibleSettlementIcon:UpdateInn()
  if not (self.worldPosition and self.innIcon) or not self:IsSettlement() and not self:IsOutpost() then
    return
  end
  local territoryId = PlayerHousingClientRequestBus.Broadcast.GetFastTravelToTerritoryIdByPosition(Vector3(self.worldPosition.x, self.worldPosition.y, 0), true)
  local isThisInnActive = PlayerHousingClientRequestBus.Broadcast.HasFastTravelPointInTerritory(territoryId, true)
  local staticInnData = isThisInnActive and StaticStationData.YourInnInteract or StaticStationData.InnInteract
  local onFocus, onUnfocus
  if isThisInnActive then
    onFocus = self.OnFocusInn
    onUnfocus = self.OnUnfocusHome
  end
  self.innIcon:SetStationIconInfo(staticInnData.name, staticInnData.description, staticInnData.image, self, self.OnStationRightClick, onFocus, onUnfocus)
  UiImageBus.Event.SetSpritePathname(self.innIcon.Properties.Icon, staticInnData.icon)
end
function CollapsibleSettlementIcon:GetRelativeAnchors(offset, pos)
  local anchors = UiAnchors(0, 0, 0, 0)
  anchors.left = (offset.x + pos.x + self.SETTLEMENT_HALF_WIDTH) / self.SETTLEMENT_MAP_WIDTH
  anchors.top = (self.SETTLEMENT_HALF_WIDTH - (pos.y + offset.y)) / self.SETTLEMENT_MAP_WIDTH
  anchors.right = anchors.left
  anchors.bottom = anchors.top
  return anchors
end
function CollapsibleSettlementIcon:OnStationRightClick(stationEntity)
  DynamicBus.MagicMap.Broadcast.MapRightClick()
end
function CollapsibleSettlementIcon:IsOutpostRushOutpost()
  return self.iconType == self.markersLayer.iconTypes.OutpostRushOutpost
end
function CollapsibleSettlementIcon:IsSettlement()
  return self.iconType == self.markersLayer.iconTypes.Settlement
end
function CollapsibleSettlementIcon:IsOutpost()
  return self.iconType == self.markersLayer.iconTypes.Outpost
end
function CollapsibleSettlementIcon:IsFortress()
  return self.iconType == self.markersLayer.iconTypes.Territory
end
function CollapsibleSettlementIcon:UpdateAnchorsAndVisiblity()
  if not (self.worldPosition and self.markersLayer) or not self.markersLayer.worldMapData then
    return
  end
  local tl = self.worldPosition:Clone()
  local br = self.worldPosition:Clone()
  tl.x = tl.x - self.SETTLEMENT_HALF_WIDTH
  tl.y = tl.y + self.SETTLEMENT_HALF_WIDTH
  br.x = br.x + self.SETTLEMENT_HALF_WIDTH
  br.y = br.y - self.SETTLEMENT_HALF_WIDTH
  local anchors = self.markersLayer:WorldPositionToAnchors(tl)
  local anchorsBR = self.markersLayer:WorldPositionToAnchors(br)
  self.isInWorldBounds = self.markersLayer.MagicMap:IsWorldPositionInBounds(self.worldPosition, self.markersLayer.worldMapData.bounds)
  UiElementBus.Event.SetIsEnabled(self.entityId, self.isInWorldBounds)
  anchors.right = anchorsBR.right
  anchors.bottom = anchorsBR.bottom
  UiTransform2dBus.Event.SetAnchorsScript(self.entityId, anchors)
end
function CollapsibleSettlementIcon:SetOutpostRushIcon(markersLayer, iconData)
  self.markersLayer = markersLayer
  self.worldPosition = iconData.position
  self.outpostIdx = iconData.outpostIdx
  self.iconType = self.markersLayer.iconTypes.OutpostRushOutpost
  self.offset = {x = 0, y = 0}
  self.landmarks = {}
  local storageShedIds = {
    tostring(2817720134),
    tostring(1056681724),
    tostring(1241292394)
  }
  local commandPostIds = {
    tostring(2271941924),
    tostring(509756574),
    tostring(1768256520)
  }
  local armoryIds = {
    tostring(1738362627),
    tostring(4271120057),
    tostring(2308124207)
  }
  local defense1Ids = {
    tostring(3355800430),
    tostring(3811057837),
    tostring(4197650924)
  }
  local defense2Ids = {
    tostring(1359749844),
    tostring(2049011991),
    tostring(1664761942)
  }
  local defense3Ids = {
    tostring(638259778),
    tostring(220610945),
    tostring(339570880)
  }
  local gate1Ids = {
    tostring(2266539104),
    tostring(2889217955),
    tostring(3039741666)
  }
  local gate2Ids = {
    tostring(504493530),
    tostring(893167129),
    tostring(740792152)
  }
  local protectionWardIds = {
    tostring(1186990799),
    tostring(3754515317),
    tostring(2832100323)
  }
  local summoningCircleIds = {
    tostring(3675708160),
    tostring(3645924697),
    tostring(3633450862)
  }
  local stationIconDatas = {
    {
      staticData = StaticStationData.OR_Storage,
      locationDataLayerId = storageShedIds[self.outpostIdx] .. ".position"
    },
    {
      staticData = StaticStationData.OR_Armory,
      locationDataLayerId = armoryIds[self.outpostIdx] .. ".position"
    },
    {
      staticData = StaticStationData.OR_CommandPost,
      locationDataLayerId = commandPostIds[self.outpostIdx] .. ".position"
    },
    {
      staticData = StaticStationData.OR_Gate,
      locationDataLayerId = gate1Ids[self.outpostIdx] .. ".position"
    },
    {
      staticData = StaticStationData.OR_Gate,
      locationDataLayerId = gate2Ids[self.outpostIdx] .. ".position"
    },
    {
      staticData = StaticStationData.OR_Defense,
      locationDataLayerId = defense1Ids[self.outpostIdx] .. ".position"
    },
    {
      staticData = StaticStationData.OR_Defense,
      locationDataLayerId = defense2Ids[self.outpostIdx] .. ".position"
    },
    {
      staticData = StaticStationData.OR_Defense,
      locationDataLayerId = defense3Ids[self.outpostIdx] .. ".position"
    },
    {
      staticData = StaticStationData.OR_ProtectionWard,
      locationDataLayerId = protectionWardIds[self.outpostIdx] .. ".position"
    },
    {
      staticData = StaticStationData.OR_SummoningCircle,
      locationDataLayerId = summoningCircleIds[self.outpostIdx] .. ".position"
    }
  }
  for i, stationIconData in ipairs(stationIconDatas) do
    local stationIcon = self.stationIcons[i]
    stationIcon:SetStationIconInfo(stationIconData.staticData.name, stationIconData.staticData.description, stationIconData.staticData.image, self, self.OnStationRightClick)
    self:SetStationIconPosition(stationIcon.entityId, Vector2(0, 0))
    self.dataLayer:RegisterAndExecuteDataObserver(self, iconData.GetGameModeDataPath(stationIconData.locationDataLayerId), function(self, position)
      if position then
        self:SetStationIconPosition(stationIcon.entityId, position)
      end
    end)
    UiElementBus.Event.SetIsEnabled(stationIcon.entityId, true)
    UiImageBus.Event.SetSpritePathname(stationIcon.Properties.Icon, stationIconData.staticData.icon)
  end
  self.hasStations = true
  self:UpdateAnchorsAndVisiblity()
end
function CollapsibleSettlementIcon:SetSettlementIcon(markersLayer, iconData)
  self.territoryId = iconData.territoryId
  self.markersLayer = markersLayer
  self.iconType = iconData.iconType
  self.worldPosition = Vector2(iconData.worldPosition.x, iconData.worldPosition.y)
  self:FillLandmarks()
  iconData.hasInn = self.landmarks[eTerritoryLandmarkType_InnInteract] ~= nil
  iconData.hasGlobalStorage = self.landmarks[eTerritoryLandmarkType_GlobalStorage] ~= nil
  self.SimpleCapitalIcon:SetData(iconData)
  UiElementBus.Event.SetIsEnabled(self.SimpleCapitalIcon.entityId, true)
  self.hasStations = false
  self:UpdateAnchorsAndVisiblity()
  self.offset = {
    x = self.worldPosition.x - iconData.worldPosition.x,
    y = self.worldPosition.y - iconData.worldPosition.y
  }
  local currentIcon = 1
  for i, landmark in ipairs(self.landmarks) do
    local staticData = landmark.staticData
    local stationIcon = self.stationIcons[currentIcon]
    if staticData and stationIcon then
      self.hasStations = true
      currentIcon = currentIcon + 1
      stationIcon:SetStationIconInfo(staticData.name, staticData.description, staticData.image, self, self.OnStationRightClick)
      self:SetStationIconPosition(stationIcon.entityId, landmark.worldPosition)
      UiElementBus.Event.SetIsEnabled(stationIcon.entityId, true)
      UiImageBus.Event.SetSpritePathname(stationIcon.Properties.Icon, staticData.icon)
      if staticData == StaticStationData.InnInteract then
        self.innIcon = stationIcon
      end
    end
  end
  if self:IsSettlement() then
    local homeIdx = currentIcon
    self.homeIcon = self.stationIcons[homeIdx]
    if not self.homeIcon then
      local canvasId = UiElementBus.Event.GetCanvas(self.entityId)
      local objToClone = self.stationIcons[1].entityId
      local parent = UiElementBus.Event.GetParent(objToClone)
      self.homeIcon = CloneUiElement(canvasId, self.registrar, objToClone, parent, false)
      self.stationIcons[homeIdx] = self.homeIcon
    end
    self:UpdateHouse()
  end
  self:UpdateInn()
  self.dataLayer:RegisterAndExecuteDataObserver(self, "Map.Filter." .. self.markersLayer.sourceType .. ".Territory", function(self, isVisible)
    self:OnMapOutpostFilterChanged(isVisible)
  end)
end
function CollapsibleSettlementIcon:SetStationIconPosition(uiEntityId, landmarkWorldPos)
  local stationPos = {
    x = landmarkWorldPos.x,
    y = landmarkWorldPos.y
  }
  stationPos.x = stationPos.x - self.worldPosition.x
  stationPos.y = stationPos.y - self.worldPosition.y
  UiTransform2dBus.Event.SetAnchorsScript(uiEntityId, self:GetRelativeAnchors(self.offset, stationPos))
end
function CollapsibleSettlementIcon:OnMapOutpostFilterChanged(isVisible)
  if self:IsOutpost() then
    UiElementBus.Event.SetIsEnabled(self.entityId, isVisible and self.isInWorldBounds)
  end
end
function CollapsibleSettlementIcon:OnFocusInn(homeIcon)
  self:OnFocusCustom(true, homeIcon)
end
function CollapsibleSettlementIcon:OnFocusHome(homeIcon)
  self:OnFocusCustom(false, homeIcon)
end
function CollapsibleSettlementIcon:OnFocusCustom(isInn, homeIcon)
  local flyoutMenu = GetFlyoutMenu(self.dataLayer, self.registrar)
  if flyoutMenu.openingContext == self.houseIconButtonFlyoutContext and flyoutMenu:ExitHover() then
    return
  end
  local rows = {}
  if isInn then
    self.SimpleCapitalIcon:MakeFastTravelFlyout(rows, true, true)
  else
    self.SimpleCapitalIcon:MakeHomeFlyout(rows, true)
  end
  LyShineDataLayerBus.Broadcast.SetData("Hud.LocalPlayer.Flyout.IsVisible", false)
  flyoutMenu:SetSoundOnShow(self.audioHelper.MapFlyout_OnShow)
  flyoutMenu:SetSoundOnHide(self.audioHelper.MapFlyout_OnHide)
  flyoutMenu:SetOpenLocation(homeIcon.entityId)
  flyoutMenu:EnableFlyoutDelay(false, 0)
  flyoutMenu:SetRowData(rows)
  flyoutMenu:SetFadeInTime(0)
  flyoutMenu.openingContext = self.houseIconButtonFlyoutContext
end
function CollapsibleSettlementIcon:OnUnfocusHome(homeIcon)
end
function CollapsibleSettlementIcon:ShouldStationsBeVisible()
  if not self.zoomLevel then
    return false
  end
  return self.hasStations and self.zoomLevel <= self.maxLevelWithVisibleIcons
end
function CollapsibleSettlementIcon:SetSettlementIconVisible(isVisible)
  if isVisible and self:ShouldStationsBeVisible() then
    local plotEntityId = self:UpdateHouse()
    if plotEntityId and not self.playerHousingClientNotificationBusHandler then
      self.playerHousingClientNotificationBusHandler = self:BusConnect(PlayerHousingClientNotificationBus, plotEntityId)
    end
    self:UpdateInn()
  elseif not isVisible and self.playerHousingClientNotificationBusHandler then
    self:BusDisconnect(self.playerHousingClientNotificationBusHandler)
    self.playerHousingClientNotificationBusHandler = nil
  end
end
function CollapsibleSettlementIcon:SetClaimPointIconVisible(isVisible)
  if not ConfigProviderEventBus.Broadcast.GetBool("javelin.faction-control.enabled") then
    return
  end
  if isVisible and self:ShouldStationsBeVisible() and self.landmarks then
    local currentIcon = 1
    for i, landmark in ipairs(self.landmarks) do
      local staticData = landmark.staticData
      local stationIcon = self.stationIcons[currentIcon]
      if staticData and stationIcon then
        currentIcon = currentIcon + 1
        if staticData == StaticStationData.Claim and self.territoryId then
          local ownerFaction = FactionControlLandClaimClientRequestBus.Broadcast.GetFactionControlOwner(self.territoryId)
          local isClaimed = ownerFaction ~= eFactionType_None
          if isClaimed then
            local factionData = FactionCommon.factionInfoTable[ownerFaction]
            if factionData then
              local controlledByText = GetLocalizedReplacementText("@ui_factioncontrol_controlledby_inline", {
                factionName = "<font color=" .. ColorRgbaToHexString(factionData.crestBgColor) .. ">" .. factionData.factionName .. "</font>"
              })
              stationIcon:SetStationIconInfo("@ui_factioncontrol_announce_titletext", controlledByText, staticData.image, self, self.OnStationRightClick)
            end
          end
        end
      end
    end
  end
end
function CollapsibleSettlementIcon:SetZoomLevel(level)
  if not self.markersLayer then
    return
  end
  self.zoomLevel = level
  local stationsShouldBeVisible = self:ShouldStationsBeVisible()
  if self.inTransit then
    self.ScriptedEntityTweener:Stop(self.Properties.StationsLayer)
    self.ScriptedEntityTweener:Stop(self.Properties.MainIconLayer)
    UiElementBus.Event.SetIsEnabled(self.Properties.MainIconLayer, not stationsShouldBeVisible)
    UiElementBus.Event.SetIsEnabled(self.Properties.StationsLayer, stationsShouldBeVisible)
    UiTransformBus.Event.SetScale(self.Properties.MainIconLayer, not stationsShouldBeVisible and self.oneScale or self.zeroScale)
    UiTransformBus.Event.SetScale(self.Properties.StationsLayer, stationsShouldBeVisible and self.oneScale or self.zeroScale)
    self.inTransit = false
  end
  local transitionTime = 0.175
  local stationsVisible = UiElementBus.Event.IsEnabled(self.Properties.StationsLayer)
  if stationsVisible and not stationsShouldBeVisible then
    self.inTransit = true
    self.ScriptedEntityTweener:Play(self.Properties.StationsLayer, transitionTime, {
      scaleX = 0,
      scaleY = 0,
      ease = "QuadOut",
      onComplete = function()
        UiElementBus.Event.SetIsEnabled(self.Properties.StationsLayer, false)
      end
    })
    UiElementBus.Event.SetIsEnabled(self.Properties.MainIconLayer, true)
    self.ScriptedEntityTweener:Play(self.Properties.MainIconLayer, transitionTime, {
      scaleX = 1,
      scaleY = 1,
      ease = "QuadOut",
      onComplete = function()
        UiElementBus.Event.SetIsEnabled(self.Properties.MainIconLayer, true)
        self.inTransit = false
      end
    })
  elseif not stationsVisible and stationsShouldBeVisible then
    self:SetSettlementIconVisible(true)
    self:SetClaimPointIconVisible(true)
    self.inTransit = true
    self.ScriptedEntityTweener:Play(self.Properties.MainIconLayer, transitionTime, {
      scaleX = 0,
      scaleY = 0,
      ease = "QuadOut",
      onComplete = function()
        UiElementBus.Event.SetIsEnabled(self.Properties.MainIconLayer, false)
      end
    })
    UiElementBus.Event.SetIsEnabled(self.Properties.StationsLayer, true)
    self.ScriptedEntityTweener:Play(self.Properties.StationsLayer, transitionTime, {
      scaleX = 1,
      scaleY = 1,
      ease = "QuadOut",
      onComplete = function()
        UiElementBus.Event.SetIsEnabled(self.Properties.StationsLayer, true)
        self.inTransit = false
      end
    })
  end
  for i = 1, #self.stationIcons do
    local stationIcon = self.stationIcons[i]
    if stationIcon and self.zoomScales[level] then
      UiTransformBus.Event.SetScale(stationIcon.entityId, self.zoomScales[level])
    end
  end
end
return CollapsibleSettlementIcon
